<!DOCTYPE html>
<html>
<head>
    <title>EEé¸¦é¸¦ Chat Room</title>
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #f0f2f5; --panel-bg: #ffffff; --accent-color: #5dade2; --text-color: #0d0d0d;
            --secondary-text: #65676b; --border-color: #ced0d4; --my-message-bg: #5dade2;
            --their-message-bg: #e4e6eb; --private-msg-bg: #fffbe6; --private-msg-text-color: #333;
            --display-font: 'ZCOOL KuaiLe', cursive;
        }
        body[data-theme='cat-theme'] {
            --bg-color: #fdf2f6; --panel-bg: rgba(255, 255, 255, 0.85); --accent-color: #ff85a2;
            --text-color: #4a4a4a; --secondary-text: #a88fb8; --border-color: #ffc2d4;
            --my-message-bg: #ffb9d4; --their-message-bg: #ffffff; --private-msg-bg: #f5f3ff;
        }
        html, body { height: 100%; margin: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; display: flex; background-color: var(--bg-color); overflow: hidden; transition: background-color 0.5s ease; }
        #chat-container, #welcome-container { display: flex; width: 100%; height: 100%; position: relative; z-index: 1; }
        .hidden { display: none !important; }
        #welcome-container { flex-direction: column; justify-content: center; align-items: center; text-align: center; }
        #welcome-container h1 { font-size: 2.5em; color: var(--text-color); }
        #welcome-container p { font-size: 1.2em; color: var(--secondary-text); margin-bottom: 40px; }
        .welcome-buttons button { font-size: 1.2em; padding: 15px 30px; margin: 0 10px; border: none; border-radius: 8px; cursor: pointer; background-color: var(--accent-color); color: white; }
        @keyframes fall { 0% { transform: translateY(-10vh); opacity: 1; } 100% { transform: translateY(110vh) rotate(720deg); opacity: 0; } }
        #special-effects-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; pointer-events: none; }
        .flower { position: absolute; background-size: contain; background-repeat: no-repeat; background-image: url('https://api.iconify.design/emojione/fallen-leaf.svg?color=%23c4a484'); animation: fall linear infinite; }
        #birthday-cake { position: fixed; z-index: 0; right: -20px; bottom: -20px; width: 350px; height: 350px; opacity: 0; transform: scale(0.8); transition: all 0.8s ease-in-out; pointer-events: none; }
        #cake-canvas { width: 100%; height: 100%; }
        body[data-theme='cat-theme'] #birthday-cake { opacity: 0.95; transform: scale(1); }
        #cat-mascot { position: fixed; bottom: 20px; left: 20px; width: 120px; height: 120px; cursor: grab; z-index: 101; transition: opacity 0.3s ease, transform 0.3s ease; opacity: 0; pointer-events: none; }
        #cat-canvas { width: 100%; height: 100%; }
        body[data-theme='cat-theme'] #cat-mascot { opacity: 1; pointer-events: auto; }
        #cat-mascot:active { cursor: grabbing; transform: scale(1.1); }
        #cat-mascot.tapped { animation: cat-tap-animation 0.5s ease; }
        @keyframes cat-tap-animation { 0% { transform: scale(1.1); } 50% { transform: scale(0.9) rotate(5deg); } 100% { transform: scale(1.1) rotate(-5deg); } }
        #sidebar { width: 280px; background-color: var(--panel-bg); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; padding: 20px; box-sizing: border-box; height: 100%; }
        #sidebar h2 { margin: 0 0 5px 0; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
        #sidebar #room-name-display { font-size: 0.8em; color: var(--secondary-text); margin-bottom: 15px; }
        #user-list { list-style-type: none; padding: 0; margin: 0; overflow-y: auto; flex-grow: 1; }
        #user-list li { padding: 10px; border-radius: 12px; margin-bottom: 5px; }
        #user-list li.can-chat:hover { background-color: rgba(0,0,0,0.05); cursor: pointer; }
        #theme-switcher { margin-top: auto; padding-top: 20px; border: none; background: transparent; cursor: pointer; font-weight: bold; text-align: center; font-size: 1.1em; color: var(--accent-color); }
        #main-chat { flex-grow: 1; display: flex; flex-direction: column; height: 100%; }
        #main-chat::before { content: 'æ¡å„¿ç”Ÿæ—¥å¿«ä¹'; position: absolute; top: 50%; left: 50%; text-align: center; font-family: var(--display-font); font-size: 12vw; color: rgba(255, 192, 203, 0.2); transform: translate(-50%, -50%) rotate(-8deg); z-index: -1; opacity: 0; transition: opacity 0.8s ease; pointer-events:none; }
        body[data-theme='cat-theme'] #main-chat::before { opacity: 1; }
        #messages { flex-grow: 1; padding: 20px; overflow-y: auto; list-style-type: none; margin: 0; display: flex; flex-direction: column; }
        #messages li { display: flex; flex-direction: column; margin-bottom: 12px; max-width: 75%; width: -moz-fit-content; width: fit-content; opacity: 0; animation: slideUp 0.4s forwards; }
         .message-bubble {
            display: inline-block;
            padding: 8px 12px;    /* ã€ä¿®æ­£ã€‘å¤§å¹…å‡å°‘ä¸Šä¸‹å†…è¾¹è·ï¼Œé€‚åº¦å‡å°‘å·¦å³å†…è¾¹è· */
            border-radius: 18px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
            word-break: break-all;
            text-align: left;
        }
        @keyframes slideUp { to { opacity: 1; transform: translateY(0); } }
        /* ã€å·²ä¿®æ­£ã€‘æ¢å¤äº†ç”Ÿæ—¥ä¸»é¢˜ä¸‹æ°”æ³¡çš„è¾¹æ¡†ã€é˜´å½±ã€ç›¸å¯¹å®šä½å’Œè´è¶ç»“æ ·å¼ */
        body[data-theme='cat-theme'] .message-bubble {
            border: 2px solid #ffdae5;
            box-shadow: 0 4px 12px rgba(255, 133, 162, 0.15);
            position: relative;
            padding: 10px 16px;
        }
        body[data-theme='cat-theme'] .message-bubble::before,
        body[data-theme='cat-theme'] .message-bubble::after {
            content: 'ğŸ€'; position: absolute; font-size: 16px; opacity: 0.8;
        }
        body[data-theme='cat-theme'] .message-bubble::before { top: -10px; left: 15px; transform: rotate(-20deg); }
        body[data-theme='cat-theme'] .message-bubble::after { bottom: -12px; right: 15px; transform: rotate(15deg); }
        li.my-message { align-self: flex-end; align-items: flex-end; }
        li.their-message { align-self: flex-start; align-items: flex-start; }
        .my-message .message-bubble { background: var(--my-message-bg); color: #fff; }
        .their-message .message-bubble { background-color: var(--their-message-bg); color: var(--text-color); }
        .private-message .message-bubble { background-color: var(--private-msg-bg); border: 1px dashed var(--accent-color); color: var(--private-msg-text-color) !important; }
        li.system-message { align-self: center; font-style: italic; color: var(--secondary-text); }
        .message-sender { font-weight: bold; margin-bottom: 5px; font-size: 0.9em; padding: 0 5px; color: var(--secondary-text); }
        #form { display: flex; padding: 20px; border-top: 1px solid var(--border-color); background-color: var(--panel-bg); }
        #input { border: 1px solid var(--border-color); background-color: var(--their-message-bg); padding: 10px 18px; flex-grow: 1; border-radius: 30px; margin-right: 10px; font-size: 1em; color: var(--text-color); }
        #input:focus { outline: none; border-color: var(--accent-color); }
        #form button { background: var(--accent-color); border: none; padding: 10px 20px; color: white; border-radius: 30px; cursor: pointer; font-size: 1em; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,.6); display: flex; justify-content: center; align-items: center; z-index: 1000; visibility: hidden; opacity: 0; transition: opacity 0.3s ease; }
        .overlay.visible { visibility: visible; opacity: 1; }
        .modal-box { background: var(--panel-bg); padding: 30px 40px; border-radius: 12px; text-align: center; }
        .modal-box input { display: block; width: 100%; box-sizing: border-box; padding: 12px; font-size: 1.1em; border: 1px solid var(--border-color); border-radius: 8px; margin: 15px auto; }
        .modal-box .button-group { display: flex; justify-content: center; gap: 10px; margin-top: 10px;}
        .modal-box button { padding: 12px 25px; font-size: 1.1em; border: none; border-radius: 8px; cursor: pointer; }
        .modal-box .primary-btn { background: var(--accent-color); color: white; }
        .modal-box .secondary-btn { background: #ccc; }
        #share-room-overlay p { margin-top: 0; }
        .likes-container { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 6px; padding: 0 5px; max-width: 100%; }
        .like-heart { font-size: 0.8em; background-color: rgba(0, 0, 0, 0.05); padding: 2px 8px; border-radius: 10px; color: var(--secondary-text); }
        .like-heart.my-like { background-color: #ffe0e0; cursor: pointer; }
        @media (max-width: 768px) { #sidebar { position: fixed; left:0; top:0; width:80%; max-width:300px; z-index: 100; transform: translateX(-100%); transition: transform 0.3s ease-in-out; } body.sidebar-open #sidebar { transform: translateX(0); } #toggle-users { display: block; position: fixed; top: 15px; left: 15px; z-index: 20; background: var(--accent-color); color: white; border: none; width: 40px; height: 40px; border-radius: 50%; font-size:20px; } }
        @media (min-width: 769px) { #toggle-users { display: none; } }
    </style>
</head>
<body>

<div id="special-effects-container"></div>
<div id="birthday-cake"><canvas id="cake-canvas"></canvas></div>
<div id="cat-mascot"><canvas id="cat-canvas"></canvas></div>

<div id="welcome-container">
    <h1>æ¬¢è¿æ¥åˆ°ç§äººèŠå¤©å®¤</h1>
    <p>åˆ›å»ºä¸€ä¸ªæˆ¿é—´æˆ–åŠ å…¥æœ‹å‹çš„æˆ¿é—´</p>
    <div class="welcome-buttons">
        <button id="create-room-btn">åˆ›å»ºæ–°æˆ¿é—´</button>
        <button id="join-room-btn">åŠ å…¥æˆ¿é—´</button>
    </div>
</div>

<div id="create-room-overlay" class="overlay">
    <div class="modal-box">
        <h2>åˆ›å»ºæ–°æˆ¿é—´</h2>
        <form id="create-room-form">
            <input id="create-room-name" placeholder="æˆ¿é—´åç§°" required>
            <input id="create-room-password" type="password" placeholder="æˆ¿é—´å¯†ç  (å¯ä¸å¡«)">
            <div class="button-group">
                <button type="submit" class="primary-btn">åˆ›å»º</button>
                <button type="button" class="secondary-btn" data-close>å–æ¶ˆ</button>
            </div>
        </form>
    </div>
</div>

<!-- ã€æ–°å¢ã€‘åˆ›å»ºæˆåŠŸåç”¨äºåˆ†äº«é“¾æ¥çš„æ¨¡æ€æ¡† -->
<div id="share-room-overlay" class="overlay">
    <div class="modal-box">
        <h2>åˆ›å»ºæˆåŠŸï¼</h2>
        <p>å¤åˆ¶ä¸‹é¢çš„é“¾æ¥åˆ†äº«ç»™ä½ çš„æœ‹å‹ï¼š</p>
        <input type="text" id="room-link-input" readonly>
        <div class="button-group" style="margin-top: 20px;">
             <button type="button" id="copy-link-btn" class="secondary-btn">å¤åˆ¶é“¾æ¥</button>
             <button type="button" id="join-now-btn" class="primary-btn">ç«‹å³åŠ å…¥</button>
        </div>
    </div>
</div>

<div id="join-room-overlay" class="overlay">
    <div class="modal-box">
        <h2>åŠ å…¥æˆ¿é—´</h2>
        <form id="join-room-form">
            <input id="join-room-id" placeholder="è¾“å…¥æˆ¿é—´IDæˆ–ç²˜è´´é“¾æ¥" required>
             <div class="button-group">
                <button type="submit" class="primary-btn">ä¸‹ä¸€æ­¥</button>
                <button type="button" class="secondary-btn" data-close>å–æ¶ˆ</button>
            </div>
        </form>
    </div>
</div>

<div id="login-overlay" class="overlay">
    <div class="modal-box">
        <h2 id="login-room-name">åŠ å…¥æˆ¿é—´</h2>
        <form id="login-form">
            <input id="nickname-input" autocomplete="off" placeholder="è¾“å…¥ä½ çš„æ˜µç§°" required />
            <input id="password-input" type="password" placeholder="è¾“å…¥æˆ¿é—´å¯†ç " />
            <div class="button-group">
                <button type="submit" class="primary-btn">åŠ å…¥</button>
                <button type="button" class="secondary-btn" data-close>è¿”å›</button>
            </div>
        </form>
    </div>
</div>

<div id="pm-overlay" class="overlay">
    <div class="modal-box">
        <h2 id="pm-title">å‘é€ç§ä¿¡</h2>
        <form id="pm-form">
            <input id="pm-input" autocomplete="off" required />
            <div class="button-group">
                <button type="submit" class="primary-btn">å‘é€</button>
                <button type="button" class="secondary-btn" data-close>å–æ¶ˆ</button>
            </div>
        </form>
    </div>
</div>

<div id="chat-container" class="hidden">
    <div id="sidebar">
        <h2>åœ¨çº¿ç”¨æˆ·</h2>
        <p id="room-name-display"></p>
        <ul id="user-list"></ul>
        <button id="theme-switcher">âœ¨ åˆ‡æ¢åˆ° æ¡å„¿ç”Ÿæ—¥ç‰ˆ</button>
    </div>
    <div id="main-chat">
        <ul id="messages"></ul>
        <form id="form"><input id="input" autocomplete="off" placeholder="è¾“å…¥æ¶ˆæ¯..." /><button>å‘é€</button></form>
    </div>
</div>
<button id="toggle-users" class="hidden">&#9776;</button>

<script src="/socket.io/socket.io.js"></script>
<script>
    const socket = io();
    const body = document.body;
    let myNickname = '', currentRoomId = '';

    // --- å…ƒç´ è·å– ---
    const welcomeContainer = document.getElementById('welcome-container');
    const chatContainer = document.getElementById('chat-container');
    const overlays = document.querySelectorAll('.overlay');
    const createRoomBtn = document.getElementById('create-room-btn');
    const joinRoomBtn = document.getElementById('join-room-btn');
    const toggleButton = document.getElementById('toggle-users');
    const copyLinkBtn = document.getElementById('copy-link-btn');
    const joinNowBtn = document.getElementById('join-now-btn');
    const createRoomOverlay = document.getElementById('create-room-overlay');
    const shareRoomOverlay = document.getElementById('share-room-overlay');
    const joinRoomOverlay = document.getElementById('join-room-overlay');
    const loginOverlay = document.getElementById('login-overlay');
    const pmOverlay = document.getElementById('pm-overlay');
    const createRoomForm = document.getElementById('create-room-form');
    const joinRoomForm = document.getElementById('join-room-form');
    const loginForm = document.getElementById('login-form');
    const pmForm = document.getElementById('pm-form');
    const form = document.getElementById('form');
    const createRoomNameInput = document.getElementById('create-room-name');
    const createRoomPasswordInput = document.getElementById('create-room-password');
    const roomLinkInput = document.getElementById('room-link-input');
    const joinRoomIdInput = document.getElementById('join-room-id');
    const nicknameInput = document.getElementById('nickname-input');
    const passwordInput = document.getElementById('password-input');
    const pmInput = document.getElementById('pm-input');
    const input = document.getElementById('input');
    const loginRoomName = document.getElementById('login-room-name');
    const pmTitle = document.getElementById('pm-title');
    const roomNameDisplay = document.getElementById('room-name-display');
    const messages = document.getElementById('messages');
    const userList = document.getElementById('user-list');
    let pmTargetUser = '';
    const themeSwitcher = document.getElementById('theme-switcher');
    const effectsContainer = document.getElementById('special-effects-container');
    const catMascot = document.getElementById('cat-mascot');
    const catCanvas = document.getElementById('cat-canvas');
    const cakeCanvas = document.getElementById('cake-canvas');

    // --- é€šç”¨å‡½æ•° ---
    function showOverlay(overlay) { hideOverlays(); overlay.classList.add('visible'); }
    function hideOverlays() { overlays.forEach(o => o.classList.remove('visible')); }

    // --- é¡µé¢åˆå§‹åŒ–ä¸URLå¤„ç† ---
    document.addEventListener('DOMContentLoaded', () => {
        const roomIdFromUrl = new URLSearchParams(window.location.search).get('room');
        if (roomIdFromUrl) {
            welcomeContainer.classList.add('hidden');
            socket.emit('join check', roomIdFromUrl);
        }
        makeDraggable(catMascot);
        applyTheme(localStorage.getItem('chat_theme') || 'default');
    });

    // --- æŒ‰é’®ä¸è¡¨å•äº‹ä»¶ç»‘å®š ---
    createRoomBtn.addEventListener('click', () => showOverlay(createRoomOverlay));
    joinRoomBtn.addEventListener('click', () => showOverlay(joinRoomOverlay));
    document.querySelectorAll('[data-close]').forEach(btn => {
        btn.addEventListener('click', () => {
            btn.closest('.overlay').classList.remove('visible');
        });
    });

    copyLinkBtn.addEventListener('click', () => {
        roomLinkInput.select();
        try {
            document.execCommand('copy');
            alert('é“¾æ¥å·²å¤åˆ¶!');
        } catch (err) {
            alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ã€‚');
        }
    });

    joinNowBtn.addEventListener('click', () => {
        location.href = roomLinkInput.value;
    });

    createRoomForm.addEventListener('submit', e => { e.preventDefault(); socket.emit('create room', { roomName: createRoomNameInput.value.trim(), password: createRoomPasswordInput.value }); });
    joinRoomForm.addEventListener('submit', e => { e.preventDefault(); let id = joinRoomIdInput.value.trim(); try { id = new URL(id).searchParams.get('room') || id; } catch (_) {} if(id) { location.href = `${location.origin}${location.pathname}?room=${id}`; } });
    loginForm.addEventListener('submit', e => { e.preventDefault(); const username = nicknameInput.value.trim(); if (username) { loginForm.querySelector('button').disabled = true; socket.emit('join room', { roomId: currentRoomId, username, password: passwordInput.value }); } });
    pmForm.addEventListener('submit', e => { e.preventDefault(); const msg = pmInput.value.trim(); if (msg) { socket.emit('private message', { to: pmTargetUser, msg }); pmInput.value = ''; hideOverlays(); } });
    form.addEventListener('submit', e => { e.preventDefault(); const msg = input.value.trim(); if (msg) { socket.emit('chat message', msg); input.value = ''; } });
    toggleButton.addEventListener('click', () => body.classList.toggle('sidebar-open'));

    // --- Socket.IO äº‹ä»¶ç›‘å¬ ---
    // ã€å·²ä¿®æ”¹ã€‘åˆ›å»ºæˆ¿é—´æˆåŠŸåï¼Œæ˜¾ç¤ºåˆ†äº«æ¨¡æ€æ¡†
    socket.on('room created', (roomId) => {
        roomLinkInput.value = `${location.origin}${location.pathname}?room=${roomId}`;
        showOverlay(shareRoomOverlay);
    });

    socket.on('room exists', (data) => {
        currentRoomId = new URLSearchParams(window.location.search).get('room');
        loginRoomName.textContent = `åŠ å…¥æˆ¿é—´: ${data.name}`;
        passwordInput.style.display = data.hasPassword ? 'block' : 'none';
        passwordInput.required = data.hasPassword;
        showOverlay(loginOverlay);
        nicknameInput.focus();
    });
    
    socket.on('room not found', () => { alert('æˆ¿é—´ä¸å­˜åœ¨æˆ–å·²å…³é—­ï¼'); location.href = location.origin; });
    
    socket.on('login success', (roomName) => {
        myNickname = nicknameInput.value.trim();
        hideOverlays();
        welcomeContainer.classList.add('hidden');
        chatContainer.classList.remove('hidden');
        toggleButton.classList.remove('hidden');
        roomNameDisplay.textContent = `æˆ¿é—´: ${roomName}`;
        input.focus();
    });
    
    socket.on('login failed', (reason) => { alert(reason); loginForm.querySelector('button').disabled = false; });
    socket.on('nickname taken', () => { alert('è¿™ä¸ªæ˜µç§°å·²ç»è¢«ä½¿ç”¨å•¦ï¼'); loginForm.querySelector('button').disabled = false; nicknameInput.focus(); nicknameInput.select(); });
    
    socket.on('user joined', (username) => createMessageElement({ msg: `${username} åŠ å…¥äº†èŠå¤©`, type: 'system' }));
    socket.on('user left', (username) => { if(username) createMessageElement({ msg: `${username} ç¦»å¼€äº†èŠå¤©`, type: 'system' }); });
    
    socket.on('chat message', (data) => createMessageElement({ ...data, from: data.username, type: 'public' }));
    socket.on('private message', (data) => createMessageElement({ ...data, type: 'private' }));

    socket.on('update user list', (users) => {
        userList.innerHTML = '';
        users.forEach(user => {
            const li = document.createElement('li');
            li.textContent = user;
            if (user === myNickname) { 
                li.textContent += ' (ä½ )';
            } else {
                li.classList.add('can-chat');
                li.title = `å‘é€ç§ä¿¡ç»™ ${user}`;
                li.addEventListener('click', () => {
                    pmTargetUser = user;
                    pmTitle.textContent = `å‘é€ç§ä¿¡ç»™ ${user}`;
                    pmInput.value = '';
                    showOverlay(pmOverlay);
                    pmInput.focus();
                });
            }
            userList.appendChild(li);
        });
    });

    socket.on('update likes', (data) => {
        const { messageId, likes } = data;
        const container = document.querySelector(`.likes-container[data-message-id="${messageId}"]`);
        if (container) {
            renderLikes(container, likes, messageId);
        }
    });
        // --- ã€æ–°å¢ã€‘ç½‘ç»œçŠ¶æ€å¤„ç† ---
    socket.on('disconnect', (reason) => {
        // åˆ›å»ºä¸€ä¸ªæç¤ºæ¶ˆæ¯
        const item = document.createElement('li');
        item.id = 'reconnecting-message'; // ç»™å®ƒä¸€ä¸ªIDï¼Œæ–¹ä¾¿ä¹‹åç§»é™¤
        item.className = 'system-message';
        item.textContent = 'âš ï¸ ç½‘ç»œè¿æ¥å·²æ–­å¼€ï¼Œæ­£åœ¨å°è¯•é‡è¿...';
        messages.appendChild(item);
        messages.scrollTop = messages.scrollHeight;

        // ç¦ç”¨è¾“å…¥æ¡†
        input.disabled = true;
        form.querySelector('button').disabled = true;
    });

    socket.on('connect', () => {
        // å¦‚æœé¡µé¢ä¸­å­˜åœ¨é‡è¿æç¤ºï¼Œè¯´æ˜æ˜¯æ–­çº¿åé‡è¿æˆåŠŸçš„
        const reconnectingMsg = document.getElementById('reconnecting-message');
        if (reconnectingMsg) {
            reconnectingMsg.remove(); // ç§»é™¤â€œæ­£åœ¨é‡è¿â€çš„æç¤º

            const item = document.createElement('li');
            item.className = 'system-message';
            item.innerHTML = 'âœ… å·²é‡æ–°è¿æ¥ã€‚<br>ä¸ºç¡®ä¿æ‚¨çš„èº«ä»½ï¼Œè¯·<strong>åˆ·æ–°é¡µé¢</strong>é‡æ–°åŠ å…¥æˆ¿é—´ã€‚';
            messages.appendChild(item);
            messages.scrollTop = messages.scrollHeight;
            
            // ä¿æŒè¾“å…¥æ¡†ç¦ç”¨ï¼Œå¼ºåˆ¶ç”¨æˆ·åˆ·æ–°
            input.disabled = true;
            form.querySelector('button').disabled = true;
        }
    });

    // --- æ¶ˆæ¯ä¸ç‚¹èµæ¸²æŸ“ ---
    function createMessageElement(data) {
        const shouldScroll = messages.scrollTop + messages.clientHeight >= messages.scrollHeight - 30;
        const li = document.createElement('li');

        if (data.type === 'system') {
            li.className = 'system-message';
            li.textContent = data.msg;
        } else {
            const sender = document.createElement('span');
            sender.className = 'message-sender';
            
            if (data.from === myNickname) { li.classList.add('my-message'); } 
            else { li.classList.add('their-message'); }

            const bubble = document.createElement('div');
            bubble.className = 'message-bubble';
            bubble.textContent = data.msg;

            // è°ƒæ•´é€»è¾‘ï¼šå…ˆå¤„ç†å‘é€è€…ä¿¡æ¯
            if (data.type === 'private') {
                li.classList.add('private-message');
                sender.textContent = `[ç§ä¿¡] ${data.from} å¯¹ ${data.to}:`;
                li.appendChild(sender); // ç§ä¿¡æ€»æ˜¯æ˜¾ç¤ºå‘é€è€…
            } else if (data.from !== myNickname) {
                sender.textContent = data.from;
                li.appendChild(sender); // å…¬å¼€æ¶ˆæ¯åªæ˜¾ç¤ºåˆ«äººçš„åå­—
            }
            bubble.className = 'message-bubble';
            bubble.textContent = data.msg;
            bubble.addEventListener('dblclick', () => socket.emit('toggle like', data.id));
            li.appendChild(bubble);

            const likesContainer = document.createElement('div');
            likesContainer.className = 'likes-container';
            likesContainer.dataset.messageId = data.id;
            li.appendChild(likesContainer);

            if (data.likes && data.likes.length > 0) {
                renderLikes(likesContainer, data.likes, data.id);
            }
        }
        messages.appendChild(li);
        if (shouldScroll) messages.scrollTop = messages.scrollHeight;
    }

    function renderLikes(container, likes, messageId) {
        container.innerHTML = '';
        if (likes.length === 0) return;

        likes.forEach(username => {
            const heartSpan = document.createElement('span');
            heartSpan.className = 'like-heart';
            heartSpan.textContent = `â¤ï¸ ${username}`;
            
            if (username === myNickname) {
                heartSpan.classList.add('my-like');
                heartSpan.title = 'ç‚¹å‡»å–æ¶ˆèµ';
                heartSpan.addEventListener('click', () => socket.emit('toggle like', messageId));
            }
            container.appendChild(heartSpan);
        });
    }

    // --- Canvas ç»˜å›¾ä¸äº¤äº’é€»è¾‘ ---
    function setupCanvas(canvas) {
        const dpr = window.devicePixelRatio || 1;
        const rect = canvas.parentElement.getBoundingClientRect();
        canvas.width = rect.width * dpr;
        canvas.height = rect.height * dpr;
        const ctx = canvas.getContext('2d');
        ctx.scale(dpr, dpr);
        return ctx;
    }

    function drawCake(ctx) {
        const w = ctx.canvas.width / (window.devicePixelRatio || 1);
        const h = ctx.canvas.height / (window.devicePixelRatio || 1);
        ctx.clearRect(0, 0, w * 2, h * 2);
        
        ctx.fillStyle = '#E0C9A6';
        ctx.beginPath();
        ctx.ellipse(w * 0.5, h * 0.8, w * 0.45, h * 0.1, 0, 0, 2 * Math.PI);
        ctx.fill();

        ctx.fillStyle = '#FADADD';
        ctx.fillRect(w * 0.15, h * 0.6, w * 0.7, h * 0.2);
        
        ctx.fillStyle = '#FFFFFF';
        ctx.fillRect(w * 0.15, h * 0.58, w * 0.7, h * 0.05);

        ctx.fillStyle = '#F3C5C5';
        ctx.fillRect(w * 0.2, h * 0.4, w * 0.6, h * 0.2);

        ctx.fillStyle = '#FFFFFF';
        ctx.beginPath();
        ctx.moveTo(w * 0.2, h * 0.4);
        ctx.bezierCurveTo(w * 0.3, h * 0.45, w * 0.4, h * 0.35, w * 0.5, h * 0.4);
        ctx.bezierCurveTo(w * 0.6, h * 0.45, w * 0.7, h * 0.35, w * 0.8, h * 0.4);
        ctx.lineTo(w * 0.8, h * 0.38);
        ctx.lineTo(w * 0.2, h * 0.38);
        ctx.closePath();
        ctx.fill();

        const candleX = w * 0.5;
        const candleY = h * 0.38;
        ctx.fillStyle = '#f0e68c';
        ctx.beginPath();
        ctx.rect(candleX - w * 0.02, candleY - h * 0.15, w * 0.04, h * 0.15);
        ctx.fill();
        
        ctx.fillStyle = '#ffd700';
        ctx.beginPath();
        ctx.ellipse(candleX, candleY - h * 0.18, w * 0.02, h * 0.04, 0, 0, 2 * Math.PI);
        ctx.fill();
        ctx.fillStyle = 'rgba(255, 165, 0, 0.7)';
        ctx.beginPath();
        ctx.ellipse(candleX, candleY - h * 0.17, w * 0.015, h * 0.03, 0, 0, 2 * Math.PI);
        ctx.fill();
    }

    let eyesOpen = true;
            // --- ã€ç²¾è£…ä¿®ç‰ˆã€‘ç»˜åˆ¶çŒ«å’ªçš„å‡½æ•° ---
    function drawCat(ctx) {
        const w = ctx.canvas.width / (window.devicePixelRatio || 1);
        const h = ctx.canvas.height / (window.devicePixelRatio || 1);
        ctx.clearRect(0, 0, w * 2, h * 2);
    
        // --- åŸºç¡€è®¾ç½® ---
        const mainOutlineColor = '#5D4037';
        const faceColor = '#FFF8E1';
        const innerEarColor = '#FFCDD2';
        const blushColor = 'rgba(255, 192, 203, 0.6)';

        ctx.strokeStyle = mainOutlineColor;
        ctx.lineWidth = 3;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';

        // --- å¤´éƒ¨è½®å»“ (æ”¹ä¸ºæ¤­åœ†ï¼Œæ›´åƒçŒ«è„¸) ---
        ctx.fillStyle = faceColor;
        const headCenterX = w / 2;
        const headCenterY = h * 0.55;
        const headRadiusX = w * 0.42; // Xè½´åŠå¾„ï¼Œè®©è„¸æ›´å®½
        const headRadiusY = w * 0.4;  // Yè½´åŠå¾„
        ctx.beginPath();
        ctx.ellipse(headCenterX, headCenterY, headRadiusX, headRadiusY, 0, 0, Math.PI * 2);
        ctx.fill();
        ctx.stroke();

        // --- è€³æœµ (ä¿ç•™ç²¾è‡´ç‰ˆ) ---
        const earBaseY = headCenterY - headRadiusY * 0.85;
        const earTipY = headCenterY - headRadiusY * 1.3;
        // å·¦è€³
        ctx.beginPath();
        ctx.moveTo(headCenterX - headRadiusX * 0.25, earBaseY);
        ctx.lineTo(headCenterX - headRadiusX * 0.5, earTipY);
        ctx.lineTo(headCenterX - headRadiusX * 0.75, earBaseY + headRadiusY * 0.1);
        ctx.closePath();
        ctx.fillStyle = faceColor;
        ctx.fill();
        ctx.stroke();
        // å³è€³
        ctx.beginPath();
        ctx.moveTo(headCenterX + headRadiusX * 0.25, earBaseY);
        ctx.lineTo(headCenterX + headRadiusX * 0.5, earTipY);
        ctx.lineTo(headCenterX + headRadiusX * 0.75, earBaseY + headRadiusY * 0.1);
        ctx.closePath();
        ctx.fill();
        ctx.stroke();
        // å†…è€³
        ctx.fillStyle = innerEarColor;
        ctx.beginPath();
        ctx.moveTo(headCenterX - headRadiusX * 0.3, earBaseY);
        ctx.lineTo(headCenterX - headRadiusX * 0.48, earTipY + headRadiusY * 0.15);
        ctx.lineTo(headCenterX - headRadiusX * 0.65, earBaseY + headRadiusY * 0.05);
        ctx.closePath();
        ctx.fill();
        ctx.beginPath();
        ctx.moveTo(headCenterX + headRadiusX * 0.3, earBaseY);
        ctx.lineTo(headCenterX + headRadiusX * 0.48, earTipY + headRadiusY * 0.15);
        ctx.lineTo(headCenterX + headRadiusX * 0.65, earBaseY + headRadiusY * 0.05);
        ctx.closePath();
        ctx.fill();

        // --- ã€æ–°å¢ã€‘è…®çº¢ ---
        ctx.fillStyle = blushColor;
        const blushRadius = w * 0.1;
        ctx.beginPath();
        ctx.arc(headCenterX - headRadiusX * 0.5, headCenterY + headRadiusY * 0.1, blushRadius, 0, Math.PI * 2);
        ctx.fill();
        ctx.beginPath();
        ctx.arc(headCenterX + headRadiusX * 0.5, headCenterY + headRadiusY * 0.1, blushRadius, 0, Math.PI * 2);
        ctx.fill();

        // --- çœ¼ç› ---
        ctx.fillStyle = mainOutlineColor;
        const eyeY = headCenterY - h * 0.05;
        if (eyesOpen) {
            ctx.beginPath();
            ctx.arc(headCenterX - headRadiusX * 0.4, eyeY, w * 0.07, 0, Math.PI * 2);
            ctx.arc(headCenterX + headRadiusX * 0.4, eyeY, w * 0.07, 0, Math.PI * 2);
            ctx.fill();
        } else {
            ctx.beginPath();
            ctx.moveTo(headCenterX - headRadiusX * 0.5, eyeY);
            ctx.lineTo(headCenterX - headRadiusX * 0.3, eyeY);
            ctx.moveTo(headCenterX + headRadiusX * 0.3, eyeY);
            ctx.lineTo(headCenterX + headRadiusX * 0.5, eyeY);
            ctx.stroke();
        }
        
        // --- ã€æ–°å¢ã€‘èƒ¡é¡» ---
        ctx.strokeStyle = '#BDBDBD'; // ç°è‰²èƒ¡é¡»
        ctx.lineWidth = 2;
        const whiskerStartY = headCenterY + headRadiusY * 0.2;
        // å·¦è¾¹èƒ¡é¡»
        ctx.beginPath();
        ctx.moveTo(headCenterX - headRadiusX * 0.2, whiskerStartY);
        ctx.lineTo(headCenterX - headRadiusX * 0.7, whiskerStartY - h * 0.05);
        ctx.moveTo(headCenterX - headRadiusX * 0.2, whiskerStartY);
        ctx.lineTo(headCenterX - headRadiusX * 0.7, whiskerStartY);
        ctx.moveTo(headCenterX - headRadiusX * 0.2, whiskerStartY);
        ctx.lineTo(headCenterX - headRadiusX * 0.7, whiskerStartY + h * 0.05);
        ctx.stroke();
        // å³è¾¹èƒ¡é¡»
        ctx.beginPath();
        ctx.moveTo(headCenterX + headRadiusX * 0.2, whiskerStartY);
        ctx.lineTo(headCenterX + headRadiusX * 0.7, whiskerStartY - h * 0.05);
        ctx.moveTo(headCenterX + headRadiusX * 0.2, whiskerStartY);
        ctx.lineTo(headCenterX + headRadiusX * 0.7, whiskerStartY);
        ctx.moveTo(headCenterX + headRadiusX * 0.2, whiskerStartY);
        ctx.lineTo(headCenterX + headRadiusX * 0.7, whiskerStartY + h * 0.05);
        ctx.stroke();

        // --- ã€ä¼˜åŒ–ã€‘å˜´å·´ ---
        ctx.strokeStyle = mainOutlineColor;
        ctx.lineWidth = 3;
        const mouthY = headCenterY + headRadiusY * 0.15;
        // é¼»å­ä¸‹é¢çš„çº¿
        ctx.beginPath();
        ctx.moveTo(headCenterX, mouthY);
        ctx.lineTo(headCenterX, mouthY + h * 0.1);
        ctx.stroke();
        // "w" å½¢å¾®ç¬‘
        ctx.beginPath();
        ctx.arc(headCenterX - w * 0.1, mouthY + h * 0.1, w * 0.1, 0, Math.PI, false);
        ctx.stroke();
        ctx.beginPath();
        ctx.arc(headCenterX + w * 0.1, mouthY + h * 0.1, w * 0.1, 0, Math.PI, false);
        ctx.stroke();
    }
    
    function makeDraggable(element) {
        let isDragging = false, hasMoved = false, offsetX, offsetY;

        function onStart(e) {
            isDragging = true;
            hasMoved = false;
            const event = e.type === 'touchstart' ? e.touches[0] : e;
            const rect = element.getBoundingClientRect();
            offsetX = event.clientX - rect.left;
            offsetY = event.clientY - rect.top;
            element.style.transition = 'none';
            e.preventDefault();
        }

        function onEnd(e) {
            if (!isDragging) return;
            isDragging = false;
            element.style.transition = 'transform 0.3s ease, opacity 0.3s ease';
            if (!hasMoved) {
                element.classList.add('tapped');
                setTimeout(() => element.classList.remove('tapped'), 500);
            }
        }

        function onMove(e) {
            if (!isDragging) return;
            hasMoved = true;
            const event = e.type === 'touchmove' ? e.touches[0] : e;
            let newX = event.clientX - offsetX;
            let newY = event.clientY - offsetY;
            const maxX = window.innerWidth - element.offsetWidth;
            const maxY = window.innerHeight - element.offsetHeight;
            newX = Math.max(0, Math.min(newX, maxX));
            newY = Math.max(0, Math.min(newY, maxY));
            element.style.left = `${newX}px`;
            element.style.top = `${newY}px`;
            element.style.bottom = 'auto';
            element.style.right = 'auto';
        }

        element.addEventListener('mousedown', onStart);
        document.addEventListener('mouseup', onEnd);
        document.addEventListener('mousemove', onMove);
        element.addEventListener('touchstart', onStart, { passive: false });
        document.addEventListener('touchend', onEnd);
        document.addEventListener('touchmove', onMove, { passive: false });
    }

    // --- ä¸»é¢˜ä¸åŠ¨ç”»é€»è¾‘ ---
    const defaultThemeName = "ç®€çº¦ä¸»é¢˜";
    const catThemeName = "æ¡å„¿ç”Ÿæ—¥ç‰ˆ";
    let blinkInterval;

    function createFallingFlowers() {
        effectsContainer.innerHTML = '';
        const flowerCount = 25;
        for (let i = 0; i < flowerCount; i++) {
            const flower = document.createElement("div");
            flower.classList.add("flower");
            if (Math.random() > 0.5) flower.style.animationName = 'fall-reverse';
            const size = 20 * Math.random() + 15;
            flower.style.width = `${size}px`;
            flower.style.height = `${size}px`;
            flower.style.left = `${100 * Math.random()}vw`;
            flower.style.animationDuration = `${10 * Math.random() + 8}s`;
            flower.style.animationDelay = `${15 * Math.random()}s`;
            effectsContainer.appendChild(flower);
        }
    }
    
    function startBlinking(ctx) {
        if(blinkInterval) clearInterval(blinkInterval);
        let isBlinking = false;
        blinkInterval = setInterval(() => {
            if(isBlinking) return;
            isBlinking = true;
            eyesOpen = false;
            drawCat(ctx);
            setTimeout(() => {
                eyesOpen = true;
                drawCat(ctx);
                isBlinking = false;
            }, 200);
        }, 5000 + Math.random() * 2000);
    }
    
    function applyTheme(theme) {
        localStorage.setItem("chat_theme", theme);
        if (theme === "cat-theme") {
            body.dataset.theme = "cat-theme";
            themeSwitcher.innerHTML = `âœ¨ åˆ‡æ¢åˆ° ${defaultThemeName}`;
            createFallingFlowers();
            const catCtx = setupCanvas(catCanvas);
            drawCat(catCtx);
            startBlinking(catCtx);
            const cakeCtx = setupCanvas(cakeCanvas);
            drawCake(cakeCtx);
        } else {
            body.dataset.theme = "default";
            themeSwitcher.innerHTML = `âœ¨ åˆ‡æ¢åˆ° ${catThemeName}`;
            effectsContainer.innerHTML = "";
            if (blinkInterval) clearInterval(blinkInterval);
        }
    }

    themeSwitcher.addEventListener('click', () => {
        const current = body.dataset.theme || 'default';
        applyTheme(current === 'cat-theme' ? 'default' : 'cat-theme');
    });
</script>
</body>
</html>
